{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/zate/cc-plugins/plugins/devloop/schemas/workflow.schema.json",
  "title": "Devloop Workflow State",
  "description": "Unified workflow state tracking for devloop sessions. Captures position, metrics, and transitions across the entire development loop.",
  "type": "object",
  "required": ["schema_version", "workflow_id", "started", "last_active", "position"],
  "additionalProperties": false,
  "properties": {
    "schema_version": {
      "type": "string",
      "description": "Schema version for forward compatibility",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "examples": ["1.0.0"]
    },
    "workflow_id": {
      "type": "string",
      "description": "Unique identifier for this workflow (UUID or timestamp-based)",
      "examples": ["550e8400-e29b-41d4-a716-446655440000", "1735468800000"]
    },
    "started": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when workflow started"
    },
    "last_active": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of last workflow activity"
    },
    "position": {
      "type": "object",
      "description": "Current position within the workflow loop",
      "required": ["phase"],
      "additionalProperties": false,
      "properties": {
        "phase": {
          "type": "string",
          "description": "Current workflow phase",
          "enum": ["idea", "spike", "planning", "execution", "validation", "shipping", "complete"],
          "default": "planning"
        },
        "subphase": {
          "type": "string",
          "description": "Phase-specific subphase (depends on current phase)",
          "examples": ["exploring", "implementing", "reviewing", "testing"]
        },
        "current_task": {
          "type": ["string", "null"],
          "description": "Current task ID being worked on (e.g., '2.1')",
          "pattern": "^[0-9]+\\.[0-9]+$"
        },
        "current_command": {
          "type": ["string", "null"],
          "description": "Most recently executed devloop command",
          "enum": ["spike", "devloop", "continue", "fresh", "quick", "ship", "review", null]
        }
      }
    },
    "origin": {
      "type": "object",
      "description": "How this workflow was initiated",
      "required": ["type", "timestamp"],
      "additionalProperties": false,
      "properties": {
        "type": {
          "type": "string",
          "description": "Workflow origin type",
          "enum": ["manual", "spike", "issue", "quick"]
        },
        "source": {
          "type": "string",
          "description": "Source file or identifier (spike report, issue ID, etc.)",
          "examples": [".devloop/spikes/auth-flow.md", "BUG-123", "FEAT-456"]
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When workflow was initiated"
        }
      }
    },
    "plan": {
      "type": "object",
      "description": "Associated plan information (if exists)",
      "additionalProperties": false,
      "properties": {
        "file": {
          "type": "string",
          "description": "Relative path to plan.md",
          "examples": [".devloop/plan.md"]
        },
        "name": {
          "type": "string",
          "description": "Plan name from header",
          "maxLength": 200
        },
        "total_tasks": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of tasks in plan"
        },
        "completed_tasks": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of completed tasks"
        },
        "current_phase_name": {
          "type": "string",
          "description": "Human-readable current phase name",
          "examples": ["Phase 2: Implementation", "Phase 5: Testing"]
        }
      }
    },
    "sessions": {
      "type": "array",
      "description": "Session history for this workflow",
      "items": {
        "$ref": "#/$defs/Session"
      }
    },
    "metrics": {
      "type": "object",
      "description": "Aggregated workflow metrics",
      "additionalProperties": false,
      "properties": {
        "total_tasks_completed": {
          "type": "integer",
          "minimum": 0,
          "description": "Cumulative tasks completed across all sessions"
        },
        "total_commits": {
          "type": "integer",
          "minimum": 0,
          "description": "Total commits made during this workflow"
        },
        "total_sessions": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of sessions in this workflow"
        },
        "avg_tasks_per_session": {
          "type": "number",
          "minimum": 0,
          "description": "Average tasks completed per session"
        },
        "avg_context_peak": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Average peak context percentage across sessions"
        },
        "velocity": {
          "type": "object",
          "description": "Velocity metrics and trends",
          "additionalProperties": false,
          "properties": {
            "tasks_per_hour": {
              "type": "number",
              "minimum": 0,
              "description": "Current task completion rate"
            },
            "trend": {
              "type": "string",
              "description": "Velocity trend direction",
              "enum": ["improving", "stable", "declining", "unknown"]
            }
          }
        },
        "health": {
          "type": "object",
          "description": "Workflow health score",
          "additionalProperties": false,
          "properties": {
            "score": {
              "type": "integer",
              "minimum": 0,
              "maximum": 100,
              "description": "Overall health score (0-100)"
            },
            "factors": {
              "type": "object",
              "description": "Individual health factor scores",
              "additionalProperties": false,
              "properties": {
                "plan_freshness": {
                  "type": "integer",
                  "minimum": 0,
                  "maximum": 100,
                  "description": "Plan update recency score"
                },
                "worklog_sync": {
                  "type": "integer",
                  "minimum": 0,
                  "maximum": 100,
                  "description": "Worklog synchronization score"
                },
                "commit_frequency": {
                  "type": "integer",
                  "minimum": 0,
                  "maximum": 100,
                  "description": "Commit frequency score"
                },
                "context_management": {
                  "type": "integer",
                  "minimum": 0,
                  "maximum": 100,
                  "description": "Context refresh management score"
                }
              }
            }
          }
        }
      }
    },
    "transitions": {
      "type": "array",
      "description": "History of phase transitions",
      "items": {
        "$ref": "#/$defs/Transition"
      }
    },
    "next_action": {
      "type": "object",
      "description": "Recommended next action for user",
      "additionalProperties": false,
      "properties": {
        "recommended": {
          "type": "string",
          "description": "Recommended command or action",
          "enum": ["continue", "fresh", "commit", "ship", "review", "spike", "new_workflow", "archive"]
        },
        "reason": {
          "type": "string",
          "description": "Human-readable explanation for recommendation",
          "maxLength": 500
        },
        "alternatives": {
          "type": "array",
          "description": "Alternative actions user can take",
          "items": {
            "type": "string",
            "enum": ["continue", "fresh", "commit", "ship", "review", "spike", "new_workflow", "archive", "status"]
          }
        },
        "freshness_warning": {
          "type": "boolean",
          "description": "Whether workflow state may be stale",
          "default": false
        }
      }
    }
  },
  "$defs": {
    "Session": {
      "type": "object",
      "description": "Individual session within the workflow",
      "required": ["id", "started"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique session identifier",
          "examples": ["session-1", "20251229-143000"]
        },
        "started": {
          "type": "string",
          "format": "date-time",
          "description": "Session start timestamp"
        },
        "ended": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "Session end timestamp (null if active)"
        },
        "tasks_completed": {
          "type": "integer",
          "minimum": 0,
          "description": "Tasks completed in this session"
        },
        "commits": {
          "type": "array",
          "description": "Git commit hashes created during session",
          "items": {
            "type": "string"
          }
        },
        "context_peak_pct": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Peak context usage percentage during session"
        },
        "tokens_used": {
          "type": "integer",
          "minimum": 0,
          "description": "Total tokens consumed in this session"
        },
        "agents_spawned": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of sub-agents spawned"
        }
      }
    },
    "Transition": {
      "type": "object",
      "description": "Record of workflow phase transition",
      "required": ["from", "to", "timestamp"],
      "additionalProperties": false,
      "properties": {
        "from": {
          "type": "string",
          "description": "Previous phase",
          "enum": ["idea", "spike", "planning", "execution", "validation", "shipping", "complete"]
        },
        "to": {
          "type": "string",
          "description": "New phase",
          "enum": ["idea", "spike", "planning", "execution", "validation", "shipping", "complete"]
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When transition occurred"
        },
        "trigger": {
          "type": "string",
          "description": "What triggered the transition",
          "enum": ["manual", "auto", "checkpoint", "command"],
          "default": "manual"
        }
      }
    }
  }
}
